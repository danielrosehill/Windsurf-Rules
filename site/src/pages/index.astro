---
import Layout from '../layouts/Layout.astro';
import { readFileSync } from 'fs';
import { join } from 'path';

// Read the latest rules file
const latestRulesPath = join(process.cwd(), '..', 'latest.md');
const latestRules = readFileSync(latestRulesPath, 'utf-8');

// Extract the title and date from the content
const titleMatch = latestRules.match(/^# (.+)$/m);
const title = titleMatch ? titleMatch[1] : 'Windsurf Rules';
const dateMatch = title.match(/- (.+)$/);
const lastUpdated = dateMatch ? dateMatch[1] : 'Unknown';

// Simple markdown to HTML conversion
function markdownToHtml(markdown) {
  return markdown
    .replace(/^# (.+)$/gm, '<h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">$1</h1>')
    .replace(/^## (.+)$/gm, '<h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200 mt-8 mb-4">$1</h2>')
    .replace(/^### (.+)$/gm, '<h3 class="text-xl font-medium text-gray-700 dark:text-gray-300 mt-6 mb-3">$1</h3>')
    .replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold">$1</strong>')
    .replace(/`(.+?)`/g, '<code class="bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded text-sm font-mono">$1</code>')
    .replace(/^\* (.+)$/gm, '<li class="ml-4 list-disc">$1</li>')
    .replace(/^---$/gm, '<hr class="my-8 border-gray-300 dark:border-gray-600">')
    .replace(/\n\n/g, '</p>\n<p class="mb-4 text-gray-700 dark:text-gray-300">')
    .replace(/^(?![<])/gm, '<p class="mb-4 text-gray-700 dark:text-gray-300">');
}

const htmlContent = markdownToHtml(latestRules);
---

<Layout title={title}>
  <div class="px-4 sm:px-0">
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
      <div class="px-6 py-8">
        <div class="mb-6">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Latest Windsurf Rules</h1>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Last updated: <time class="font-medium">{lastUpdated}</time>
              </p>
            </div>
            <div class="flex space-x-3">
              <a href="/archive" 
                 class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                View Archive
              </a>
              <a href="/changelog" 
                 class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                View Changelog
              </a>
            </div>
          </div>
        </div>
        
        <div class="prose prose-lg max-w-none dark:prose-invert">
          <div class="markdown-content" set:html={htmlContent} />
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .markdown-content {
    @apply text-gray-700 dark:text-gray-300;
  }
  
  .markdown-content h1 {
    @apply text-3xl font-bold text-gray-900 dark:text-white mb-6 mt-8 first:mt-0;
  }
  
  .markdown-content h2 {
    @apply text-2xl font-semibold text-gray-800 dark:text-gray-200 mt-8 mb-4;
  }
  
  .markdown-content h3 {
    @apply text-xl font-medium text-gray-700 dark:text-gray-300 mt-6 mb-3;
  }
  
  .markdown-content table {
    @apply w-full border-collapse border border-gray-300 dark:border-gray-600 my-6;
  }
  
  .markdown-content th {
    @apply bg-gray-50 dark:bg-gray-700 px-4 py-2 border border-gray-300 dark:border-gray-600 font-semibold text-left;
  }
  
  .markdown-content td {
    @apply px-4 py-2 border border-gray-300 dark:border-gray-600;
  }
  
  .markdown-content ul {
    @apply list-disc list-inside my-4 space-y-1;
  }
  
  .markdown-content ol {
    @apply list-decimal list-inside my-4 space-y-1;
  }
  
  .markdown-content p {
    @apply mb-4 leading-relaxed;
  }
  
  .markdown-content code {
    @apply bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded text-sm font-mono;
  }
  
  .markdown-content pre {
    @apply bg-gray-100 dark:bg-gray-800 p-4 rounded-lg overflow-x-auto my-4;
  }
  
  .markdown-content blockquote {
    @apply border-l-4 border-blue-500 pl-4 italic my-4;
  }
  
  .markdown-content hr {
    @apply my-8 border-gray-300 dark:border-gray-600;
  }
</style>
